name: Coverage Gate

on:
  pull_request:
    branches: [ main, master ]
    types: [ opened, synchronize, reopened, ready_for_review ]

jobs:
  enforce-coverage:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for comparison

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests and generate coverage
      run: |
        pytest --cov=. --cov-report=xml --cov-report=json --cov-report=term

    - name: Check coverage threshold
      id: coverage_check
      run: |
        python << EOF
        import json
        import sys
        
        with open('coverage.json') as f:
            data = json.load(f)
        
        coverage = round(data['totals']['percent_covered'], 2)
        threshold = 60
        
        print(f"Current coverage: {coverage}%")
        print(f"Required threshold: {threshold}%")
        print(f"coverage={coverage}")
        print(f"threshold={threshold}")
        
        if coverage < threshold:
            print(f"::error::❌ Coverage {coverage}% is below required threshold of {threshold}%")
            print("Please add more tests to increase coverage before merging.")
            sys.exit(1)
        else:
            print(f"::notice::✅ Coverage {coverage}% meets required threshold of {threshold}%")
        EOF

    - name: Compare with base branch
      if: github.event_name == 'pull_request'
      run: |
        base_branch="${{ github.base_ref }}"
        current_coverage=$(python -c "import json; data = json.load(open('coverage.json')); print(round(data['totals']['percent_covered'], 2))")
        
        echo "Checking coverage against base branch: ${base_branch}"
        git fetch origin ${base_branch}:${base_branch} || true
        
        # Try to get base coverage (if available)
        echo "Current PR coverage: ${current_coverage}%"
        echo "Coverage must not decrease from base branch"

    - name: Post coverage comment
      if: github.event_name == 'pull_request'
      uses: py-cov-action/python-coverage-comment-action@v3
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        MINIMUM_GREEN: 60
        MINIMUM_ORANGE: 70
        FAIL_UNDER_COVERAGE: true
